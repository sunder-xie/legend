<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tqmall.legend.dao.marketing.ng.CustomerInfoDao">
    <!-- Result Map -->
    <resultMap id="BaseResultMap" type="CustomerInfo">
        <result column="id" property="id"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="gmt_create" property="gmtCreate"/>
        <result column="gmt_modified" property="gmtModified"/>
        <result column="creator" property="creator"/>
        <result column="modifier" property="modifier"/>
        <result column="shop_id" property="shopId"/>
        <result column="customer_id" property="customerId"/>
        <result column="customer_car_id" property="customerCarId"/>
        <result column="customer_name" property="customerName"/>
        <result column="mobile" property="mobile"/>
        <result column="car_license" property="carLicense"/>
        <result column="contact_name" property="contactName"/>
        <result column="contact_mobile" property="contactMobile"/>
        <result column="car_brand_id" property="carBrandId"/>
        <result column="car_brand" property="carBrand"/>
        <result column="car_series_id" property="carSeriesId"/>
        <result column="car_series" property="carSeries"/>
        <result column="car_level" property="carLevel"/>
        <result column="last_pay_time" property="lastPayTime"/>
        <result column="car_model_id" property="carModelId"/>
        <result column="car_model" property="carModel"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="total_number" property="totalNumber"/>
        <result column="car_level_tag" property="carLevelTag"/>
        <result column="appoint_create_time" property="appointCreateTime"/>
        <result column="appoint_time" property="appointTime"/>
        <result column="appoint_content" property="appointContent"/>
        <result column="mileage" property="mileage"/>
        <result column="note_keepup_time" property="noteKeepupTime"/>
        <result column="note_insurance_time" property="noteInsuranceTime"/>
        <result column="note_auditing_time" property="noteAuditingTime"/>
        <result column="note_visit_time" property="noteVisitTime"/>
        <result column="birthday" property="birthday"/>
        <result column="last_order_id" property="lastOrderId"/>
        <result column="member_card_count" property="memberCardCount"/>
    </resultMap>

    <sql id="BaseColumnList">
        <trim suffix="" suffixOverrides=",">
            <include refid="COMMON.BASE_COLUMN_LIST"/>
            shop_id as shopId,
            customer_id as customerId,
            customer_car_id as customerCarId,
            customer_name as customerName,
            mobile as mobile,
            car_license as carLicense,
            contact_name as contactName,
            contact_mobile as contactMobile,
            car_brand_id as carBrandId,
            car_brand as carBrand,
            car_series_id as carSeriesId,
            car_series as carSeries,
            car_level as carLevel,
            last_pay_time as lastPayTime,
            car_model_id as carModelId,
            car_model as carModel,
            total_amount as totalAmount,
            total_number as totalNumber,
            car_level_tag as carLevelTag,
            appoint_id as appointId,
            appoint_create_time as appointCreateTime,
            appoint_time as appointTime,
            appoint_content as appointContent,
            mileage as mileage,
            note_keepup_time as noteKeepupTime,
            note_insurance_time as noteInsuranceTime,
            note_auditing_time as noteAuditingTime,
            note_visit_time as noteVisitTime,
            birthday as birthday,
            last_order_id as lastOrderId,
            member_card_count as memberCardCount,
        </trim>

    </sql>

    <sql id="BaseColumnList2">
        <trim suffix="" suffixOverrides=",">
            a.id as id,
            a.is_deleted as isDeleted,
            a.gmt_create as gmtCreate,
            a.creator as creator,
            a.gmt_modified as gmtModified,
            a.modifier as modifier,
            a.shop_id as shopId,
            a.customer_id as customerId,
            a.customer_car_id as customerCarId,
            a.car_license as carLicense,
            a.customer_name as customerName,
            a.mobile as mobile,
            a.contact_name as contactName,
            a.contact_mobile as contactMobile,
            a.car_brand_id as carBrandId,
            a.car_brand as carBrand,
            a.car_series_id as carSeriesId,
            a.car_series as carSeries,
            a.car_level as carLevel,
            a.last_pay_time as lastPayTime,
            a.car_model_id as carModelId,
            a.car_model as carModel,
            a.total_amount as totalAmount,
            a.total_number as totalNumber,
            a.car_level_tag as carLevelTag,
            a.appoint_id as appointId,
            a.appoint_create_time as appointCreateTime,
            a.appoint_time as appointTime,
            a.appoint_content as appointContent,
            a.mileage as mileage,
            a.note_keepup_time as noteKeepupTime,
            a.note_insurance_time as noteInsuranceTime,
            a.note_auditing_time as noteAuditingTime,
            a.note_visit_time as noteVisitTime,
            a.birthday as birthday,
            a.last_order_id as lastOrderId,
            a.last_order_amount as lastOrderAmount,
            a.arrive_numbers as arriveNumbers,
            a.sign_total_amount as signTotalAmount,
            a.sign_total_order_numbers as signTotalOrderNumbers,
            a.member_card_count as memberCardCount
        </trim>
    </sql>
    <!-- 查询条件 -->
    <sql id="BaseWhereClause">
        <where>
            <trim prefixOverrides="and">
                <include refid="COMMON.BASE_WHERE_CLAUSE"/>
                <if test="shopId!= null">
                    and shop_id = #{shopId}
                </if>
                <if test="customerId!= null">
                    and customer_id = #{customerId}
                </if>
                <if test="customerCarId!= null">
                    and customer_car_id = #{customerCarId}
                </if>
                <if test="customerName!= null">
                    and customer_name = #{customerName}
                </if>
                <if test="mobile!= null">
                    and mobile = #{mobile}
                </if>
                <if test="carLicense!= null">
                    and car_license = #{carLicense}
                </if>
                <if test="contactName!= null">
                    and contact_name = #{contactName}
                </if>
                <if test="contactMobile!= null">
                    and contact_mobile = #{contactMobile}
                </if>
                <if test="carBrandId!= null">
                    and car_brand_id = #{carBrandId}
                </if>
                <if test="carBrand!= null">
                    and car_brand = #{carBrand}
                </if>
                <if test="carSeriesId!= null">
                    and car_series_id = #{carSeriesId}
                </if>
                <if test="carSeries!= null">
                    and car_series = #{carSeries}
                </if>
                <if test="carLevel!= null">
                    and car_level = #{carLevel}
                </if>
                <if test="lastPayTime!= null">
                    and date(last_pay_time) = date(#{lastPayTime})
                </if>
                <if test="minLastPayTime!= null">
                    <![CDATA[
                      and date(last_pay_time) < date(#{minLastPayTime})
                    ]]>
                </if>
                <if test="minLastPayTimeOrNull!= null">
                    <![CDATA[
                      and (date(last_pay_time) < date(#{minLastPayTimeOrNull}) or last_pay_time is null)
                    ]]>
                </if>
                <if test="maxLastPayTime!= null">
                    <![CDATA[
                      and date(last_pay_time) >= date(#{maxLastPayTime})
                    ]]>
                </if>
                <if test="carModelId!= null">
                    and car_model_id = #{carModelId}
                </if>
                <if test="carModel!= null">
                    and car_model = #{carModel}
                </if>
                <if test="totalAmount!= null">
                    and total_amount = #{totalAmount}
                </if>
                <if test="totalNumber!= null">
                    and total_number = #{totalNumber}
                </if>
                <if test="minTotalNumber!= null">
                    <![CDATA[
                      and total_number >= #{minTotalNumber}
                    ]]>
                </if>
                <if test="maxTotalNumber!= null">
                    <![CDATA[
                      and total_number < #{maxTotalNumber}
                    ]]>
                </if>
                <if test="carLevelTag!= null">
                    and car_level_tag = #{carLevelTag}
                </if>
                <if test="appointId!= null">
                    and appoint_id = #{appointId}
                </if>
                <if test="appointCreateTime!= null">
                    and appoint_create_time = #{appointCreateTime}
                </if>
                <if test="appointTime!= null">
                    and appoint_time = #{appointTime}
                </if>
                <if test="appointContent!= null">
                    and appoint_content = #{appointContent}
                </if>
                <if test="mileage!= null">
                    and mileage = #{mileage}
                </if>
                <if test="noteKeepupTime!= null">
                    and note_keepup_time = #{noteKeepupTime}
                </if>
                <if test="noteInsuranceTime!= null">
                    and note_insurance_time = #{noteInsuranceTime}
                </if>
                <if test="noteAuditingTime!= null">
                    and note_auditing_time = #{noteAuditingTime}
                </if>
                <if test="noteVisitTime!= null">
                    and note_visit_time = #{noteVisitTime}
                </if>
                <if test="birthday!= null">
                    and birthday = #{birthday}
                </if>
                <if test="daySign!= null and day != null">
                    <![CDATA[
                      and last_pay_time ${daySign} #{day}
                    ]]>
                </if>
                <if test="numberSign!= null and number != null">
                    <![CDATA[
                      and total_number ${numberSign} #{number}
                    ]]>
                </if>
                <if test="minAmount!= null">
                    <![CDATA[
                      and total_amount >= #{minAmount}
                    ]]>
                </if>
                <if test="maxAmount!= null">
                    <![CDATA[
                      and total_amount <= #{maxAmount}
                    ]]>
                </if>
                <if test="minAverage!= null">
                    <![CDATA[
                      and total_amount/total_number >= #{minAverage}
                    ]]>
                </if>
                <if test="maxAverage!= null">
                    <![CDATA[
                      and total_amount/total_number <= #{maxAverage}
                    ]]>
                </if>
                <if test="minMileage!= null">
                    <![CDATA[
                      and mileage >= #{minMileage}
                    ]]>
                </if>
                <if test="maxMileage!= null">
                    <![CDATA[
                      and mileage <= #{maxMileage}
                    ]]>
                </if>
                <if test="carType != null">
                    and concat(ifnull(car_brand,""),ifnull(car_series,""),ifnull(car_model,"")) like concat('%',#{carType},'%')
                </if>
                <if test="allot != null">
                    and user_id = 0
                </if>
                <if test="memberCardCount != null">
                    and member_card_count = #{memberCardCount}
                </if>
            </trim>
        </where>

    </sql>

    <!-- 查询条件 -->
    <sql id="BaseWhereClause2">
        <where>
            <trim prefixOverrides="and">
                <if test = "id != null">and a.id = #{id}</if>
                <if test = "isDeleted != null">and a.is_deleted = #{isDeleted}</if>
                <if test = "isDeleted == null">and a.is_deleted = 'N'</if>
                <if test = "gmtCreate != null">and a.gmt_create = #{gmtCreate}</if>
                <if test = "creator != null">and a.creator = #{creator}</if>
                <if test = "gmtModified != null">and a.gmt_modified = #{gmtModified}</if>
                <if test = "modifier != null">and a.modifier = #{modifier}</if>
                <if test="shopId!= null">
                    and a.shop_id = #{shopId}
                </if>
                <if test="customerId!= null">
                    and a.customer_id = #{customerId}
                </if>
                <if test="customerCarId!= null">
                    and a.customer_car_id = #{customerCarId}
                </if>
                <if test="customerName!= null">
                    and a.customer_name = #{customerName}
                </if>
                <if test="mobile!= null">
                    and a.mobile = #{mobile}
                </if>
                <if test="carLicense!= null">
                    and a.car_license = #{carLicense}
                </if>
                <if test="contactName!= null">
                    and a.contact_name = #{contactName}
                </if>
                <if test="contactMobile!= null">
                    and a.contact_mobile = #{contactMobile}
                </if>
                <if test="carBrandId!= null">
                    and a.car_brand_id = #{carBrandId}
                </if>
                <if test="carBrand!= null">
                    and a.car_brand = #{carBrand}
                </if>
                <if test="carSeriesId!= null">
                    and a.car_series_id = #{carSeriesId}
                </if>
                <if test="carSeries!= null">
                    and a.car_series = #{carSeries}
                </if>
                <if test="carLevel!= null">
                    and a.car_level = #{carLevel}
                </if>
                <if test="lastPayTime!= null">
                    and date(a.last_pay_time) = date(#{lastPayTime})
                </if>
                <if test="minLastPayTime!= null">
                    <![CDATA[
                      and date(a.last_pay_time) < date(#{minLastPayTime})
                    ]]>
                </if>
                <if test="minLastPayTimeOrNull!= null">
                    <![CDATA[
                      and (date(a.last_pay_time) < date(#{minLastPayTimeOrNull}) or a.last_pay_time is null)
                    ]]>
                </if>
                <if test="maxLastPayTime!= null">
                    <![CDATA[
                      and date(a.last_pay_time) >= date(#{maxLastPayTime})
                    ]]>
                </if>
                <if test="carModelId!= null">
                    and a.car_model_id = #{carModelId}
                </if>
                <if test="carModel!= null">
                    and a.car_model = #{carModel}
                </if>
                <if test="totalAmount!= null">
                    and a.total_amount = #{totalAmount}
                </if>
                <if test="totalNumber!= null">
                    and a.total_number = #{totalNumber}
                </if>
                <if test="minTotalNumber!= null">
                    <![CDATA[
                      and a.total_number >= #{minTotalNumber}
                    ]]>
                </if>
                <if test="maxTotalNumber!= null">
                    <![CDATA[
                      and a.total_number < #{maxTotalNumber}
                    ]]>
                </if>
                <if test="carLevelTag!= null">
                    and a.car_level_tag = #{carLevelTag}
                </if>
                <if test="appointId!= null">
                    and a.appoint_id = #{appointId}
                </if>
                <if test="appointCreateTime!= null">
                    and a.appoint_create_time = #{appointCreateTime}
                </if>
                <if test="appointTime!= null">
                    and a.appoint_time = #{appointTime}
                </if>
                <if test="appointContent!= null">
                    and a.appoint_content = #{appointContent}
                </if>
                <if test="mileage!= null">
                    and a.mileage = #{mileage}
                </if>
                <if test="noteKeepupTime!= null">
                    and a.note_keepup_time = #{noteKeepupTime}
                </if>
                <if test="noteInsuranceTime!= null">
                    and a.note_insurance_time = #{noteInsuranceTime}
                </if>
                <if test="noteAuditingTime!= null">
                    and a.note_auditing_time = #{noteAuditingTime}
                </if>
                <if test="noteVisitTime!= null">
                    and a.note_visit_time = #{noteVisitTime}
                </if>
                <if test="birthday!= null">
                    and a.birthday = #{birthday}
                </if>
                <if test="daySign!= null and day != null">
                    <![CDATA[
                      and a.last_pay_time ${daySign} #{day}
                    ]]>
                </if>
                <if test="numberSign!= null and number != null">
                    <![CDATA[
                      and a.total_number ${numberSign} #{number}
                    ]]>
                </if>
                <if test="minAmount!= null">
                    <![CDATA[
                      and a.total_amount >= #{minAmount}
                    ]]>
                </if>
                <if test="maxAmount!= null">
                    <![CDATA[
                      and a.total_amount <= #{maxAmount}
                    ]]>
                </if>
                <if test="minAverage!= null">
                    <![CDATA[
                      and a.total_amount/total_number >= #{minAverage}
                    ]]>
                </if>
                <if test="maxAverage!= null">
                    <![CDATA[
                      and a.total_amount/total_number <= #{maxAverage}
                    ]]>
                </if>
                <if test="minMileage!= null">
                    <![CDATA[
                      and a.mileage >= #{minMileage}
                    ]]>
                </if>
                <if test="maxMileage!= null">
                    <![CDATA[
                      and a.mileage <= #{maxMileage}
                    ]]>
                </if>
                <if test="carType != null">
                    and concat(ifnull(a.car_brand,""),ifnull(a.car_series,""),ifnull(a.car_model,"")) like concat('%',#{carType},'%')
                </if>
                <if test="allot != null">
                    and a.user_id = 0
                </if>
                <if test="memberCardCount != null">
                    and a.member_card_count = #{memberCardCount}
                </if>
            </trim>
        </where>

    </sql>

    <!-- 批量更新条件 -->
    <sql id="BaseUpdateSet">
        <set>
            <trim suffix="" suffixOverrides=",">
                <include refid="COMMON.BASE_UPDATE_SET"/>
                <if test="shopId!= null">
                    shop_id = #{shopId},
                </if>
                <if test="customerId!= null">
                    customer_id = #{customerId},
                </if>
                <if test="customerCarId!= null">
                    customer_car_id = #{customerCarId},
                </if>
                <if test="customerName!= null">
                    customer_name = #{customerName},
                </if>
                <if test="mobile!= null">
                    mobile = #{mobile},
                </if>
                <if test="carLicense!= null">
                    car_license = #{carLicense},
                </if>
                <if test="contactName!= null">
                    contact_name = #{contactName},
                </if>
                <if test="contactMobile!= null">
                    contact_mobile = #{contactMobile},
                </if>
                <if test="carBrandId!= null">
                    car_brand_id = #{carBrandId},
                </if>
                <if test="carBrand!= null">
                    car_brand = #{carBrand},
                </if>
                <if test="carSeriesId!= null">
                    car_series_id = #{carSeriesId},
                </if>
                <if test="carSeries!= null">
                    car_series = #{carSeries},
                </if>
                <if test="carLevel!= null">
                    car_level = #{carLevel},
                </if>
                <if test="lastPayTime!= null">
                    last_pay_time = #{lastPayTime},
                </if>
                <if test="carModelId!= null">
                    car_model_id = #{carModelId},
                </if>
                <if test="carModel!= null">
                    car_model = #{carModel},
                </if>
                <if test="totalAmount!= null">
                    total_amount = #{totalAmount},
                </if>
                <if test="totalNumber!= null">
                    total_number = #{totalNumber},
                </if>
                <if test="totalNumber!= null">
                    total_number = #{totalNumber},
                </if>
                <if test="appointId!= null">
                    appoint_id = #{appointId},
                </if>
                <if test="appointCreateTime!= null">
                    appoint_create_time = #{appointCreateTime},
                </if>
                <if test="appointTime!= null">
                    appoint_time = #{appointTime},
                </if>
                <if test="appointContent!= null">
                    appoint_content = #{appointContent},
                </if>
                <if test="mileage!= null">
                    mileage = #{mileage},
                </if>
                <if test="noteKeepupTime!= null">
                    note_keepup_time = #{noteKeepupTime},
                </if>
                <if test="noteInsuranceTime!= null">
                    note_insurance_time = #{noteInsuranceTime},
                </if>
                <if test="noteAuditingTime!= null">
                    note_auditing_time = #{noteAuditingTime},
                </if>
                <if test="noteVisitTime!= null">
                    note_visit_time = #{noteVisitTime},
                </if>
                <if test="birthday!= null">
                    birthday = #{birthday},
                </if>
                <if test="memberCardCount != null">
                    member_card_count = #{memberCardCount},
                </if>
            </trim>
        </set>

    </sql>

    <!-- 插入记录 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        insert into cube_customer_info (
        <trim suffix="" suffixOverrides=",">
            <include refid="COMMON.BASE_INSERT_COLUMN"/>
            <if test="shopId!= null">
                shop_id,
            </if>
            <if test="customerId!= null">
                customer_id,
            </if>
            <if test="customerCarId!= null">
                customer_car_id,
            </if>
            <if test="customerName!= null">
                customer_name,
            </if>
            <if test="mobile!= null">
                mobile,
            </if>
            <if test="carLicense!= null">
                car_license,
            </if>
            <if test="contactName!= null">
                contact_name,
            </if>
            <if test="contactMobile!= null">
                contact_mobile,
            </if>
            <if test="carBrandId!= null">
                car_brand_id,
            </if>
            <if test="carBrand!= null">
                car_brand,
            </if>
            <if test="carSeriesId!= null">
                car_series_id,
            </if>
            <if test="carSeries!= null">
                car_series,
            </if>
            <if test="carLevel!= null">
                car_level,
            </if>
            <if test="lastPayTime!= null">
                last_pay_time,
            </if>
            <if test="carModelId!= null">
                car_model_id,
            </if>
            <if test="carModel!= null">
                car_model,
            </if>
            <if test="totalAmount!= null">
                total_amount,
            </if>
            <if test="totalNumber!= null">
                total_number,
            </if>
            <if test="carLevelTag!= null">
                car_level_tag,
            </if>
            <if test="appointId!= null">
                appoint_id,
            </if>
            <if test="appointCreateTime!= null">
                appoint_create_time,
            </if>
            <if test="appointTime!= null">
                appoint_time,
            </if>
            <if test="appointContent!= null">
                appoint_content,
            </if>
            <if test="mileage!= null">
                mileage,
            </if>
            <if test="noteKeepupTime!= null">
                note_keepup_time,
            </if>
            <if test="noteInsuranceTime!= null">
                note_insurance_time,
            </if>
            <if test="noteAuditingTime!= null">
                note_auditing_time,
            </if>
            <if test="noteVisitTime!= null">
                note_visit_time,
            </if>
            <if test="birthday!= null">
                birthday,
            </if>
            <if test="memberCardCount != null">
                member_card_count,
            </if>
        </trim>
        )
        values (
        <trim suffix="" suffixOverrides=",">
            <include refid="COMMON.BASE_INSERT_VALUE"/>
            <if test="shopId!= null">
                #{shopId},
            </if>
            <if test="customerId!= null">
                #{customerId},
            </if>
            <if test="customerCarId!= null">
                #{customerCarId},
            </if>
            <if test="customerName!= null">
                #{customerName},
            </if>
            <if test="mobile!= null">
                #{mobile},
            </if>
            <if test="carLicense!= null">
                #{carLicense},
            </if>
            <if test="contactName!= null">
                #{contactName},
            </if>
            <if test="contactMobile!= null">
                #{contactMobile},
            </if>
            <if test="carBrandId!= null">
                #{carBrandId},
            </if>
            <if test="carBrand!= null">
                #{carBrand},
            </if>
            <if test="carSeriesId!= null">
                #{carSeriesId},
            </if>
            <if test="carSeries!= null">
                #{carSeries},
            </if>
            <if test="carLevel!= null">
                #{carLevel},
            </if>
            <if test="lastPayTime!= null">
                #{lastPayTime},
            </if>
            <if test="carModelId!= null">
                #{carModelId},
            </if>
            <if test="carModel!= null">
                #{carModel},
            </if>
            <if test="totalAmount!= null">
                #{totalAmount},
            </if>
            <if test="totalNumber!= null">
                #{totalNumber},
            </if>
            <if test="carLevelTag!= null">
                #{carLevelTag},
            </if>
            <if test="appointId!= null">
                #{appointId},
            </if>
            <if test="appointCreateTime!= null">
                #{appointCreateTime},
            </if>
            <if test="appointTime!= null">
                #{appointTime},
            </if>
            <if test="appointContent!= null">
                #{appointContent},
            </if>
            <if test="mileage!= null">
                #{mileage},
            </if>
            <if test="noteKeepupTime!= null">
                #{noteKeepupTime},
            </if>
            <if test="noteInsuranceTime!= null">
                #{noteInsuranceTime},
            </if>
            <if test="noteAuditingTime!= null">
                #{noteAuditingTime},
            </if>
            <if test="noteVisitTime!= null">
                #{noteVisitTime},
            </if>
            <if test="birthday!= null">
                #{birthday},
            </if>
            <if test="memberCardCount != null">
                #{memberCardCount},
            </if>
        </trim>
        )
    </insert>

    <!-- 获取对象全部结果集 -->
    <select id="select" resultMap="BaseResultMap">
        select
        <include refid="BaseColumnList"/>
        from cube_customer_info
        <include refid="BaseWhereClause"/>
        <include refid="COMMON.ORDER_BY"/>
        <include refid="COMMON.LIMIT"/>

    </select>
    <!-- 获取对象全部结果集 -->
    <select id="selectWithCardInfo" resultMap="BaseResultMap">
        select
        <include refid="BaseColumnList2"/>
        from cube_customer_info a
        <if test="memberLevelId != null">
            JOIN
            (select customer_id from legend_account_info
            WHERE id in (
            SELECT account_id
            FROM legend_member_card
            WHERE shop_id = #{shopId}
            AND card_type_id = #{memberLevelId}
            AND is_deleted = 'N'
            and expire_date >= now()
            )
            ) ai on ai.customer_id = a.customer_id
        </if>
        <include refid="BaseWhereClause2"/>
        <if test="memberLevelId != null">
        </if>
        <if test = "sorts != null">
            order by
            <foreach collection = "sorts" item = "tag" separator = ",">
                ${tag}
            </foreach>
        </if>
        <include refid="COMMON.LIMIT"/>

    </select>

    <!-- 查询总数 -->
    <select id="selectCount" resultType="java.lang.Integer">
        select count(id)
        from cube_customer_info
        <include refid="BaseWhereClause"/>
    </select>

    <!-- 查询总数 -->
    <select id="selectCount2" resultType="java.lang.Integer">
        select count(distinct a.id)
        from cube_customer_info a
        <if test="memberLevelId != null">
            join legend_account_info ai
            on ai.customer_id = a.customer_id and ai.shop_id = #{shopId}
            join legend_member_card mc
            on mc.account_id = ai.id and mc.shop_id = #{shopId}
            and mc.card_type_id = #{memberLevelId}
            and mc.expire_date >= now()
        </if>
        <include refid="BaseWhereClause2"/>
    </select>


    <!-- 根据IDS批量查询 -->
    <select id="selectByIds" resultMap="BaseResultMap">
        select
        <include refid="BaseColumnList"/>
        from cube_customer_info
        where id in (
        <foreach collection="array" index="index" item="tag" separator=",">
            #{tag}
        </foreach>
        ) and is_deleted = 'N'

    </select>

    <!-- 根据IDS批量删除 -->
    <update id="deleteByIds">
        update cube_customer_info
        set is_deleted='Y'
        where id in (
        <foreach collection="array" index="index" item="tag" separator=",">
            #{tag}
        </foreach>
        )

    </update>

    <!-- 根据ID删除 -->
    <update id="deleteById">
        update cube_customer_info
        set is_deleted='Y'
        where id=#{id}

    </update>

    <!-- 删除 -->
    <delete id="delete">
        update cube_customer_info
        set is_deleted='Y'
        <include refid="BaseWhereClause"/>
    </delete>

    <!-- 通过ID更新 -->
    <update id="updateById">
        update cube_customer_info
        <include refid="BaseUpdateSet"/>
        where id = #{id}
    </update>

    <select id="selectWithTypeCount" resultType="java.lang.Integer">
        SELECT
          count(ci.id)
        FROM
        (
          SELECT DISTINCT(customer_car_id) FROM legend_order_info WHERE order_status = 'DDYFK'
            <if test="shopId!= null">
                and shop_id = #{shopId}
            </if>
            <if test="sTime!= null">
                <![CDATA[
                  and date(confirm_time) >= date(#{sTime})
                ]]>
            </if>
            <if test="eTime!= null">
                <![CDATA[
                  and date(confirm_time) <= date(#{eTime})
                ]]>
            </if>
        ) pl
        LEFT JOIN
          cube_customer_info ci
        ON
          ci.customer_car_id = pl.customer_car_id
        WHERE
          ci.is_deleted = 'N'
        <if test="shopId!= null">
            and ci.shop_id = #{shopId}
        </if>
        <if test="totalNumber!= null">
            and ci.total_number = #{totalNumber}
        </if>
        <if test="minTotalNumber!= null">
            <![CDATA[
              and ci.total_number >= #{minTotalNumber}
            ]]>
        </if>
        <if test="maxTotalNumber!= null">
            <![CDATA[
              and ci.total_number < #{maxTotalNumber}
            ]]>
        </if>
        <if test="carLevelTag!= null">
            and ci.car_level_tag = #{carLevelTag}
        </if>
    </select>

    <select id="selectWithType" resultMap="BaseResultMap">
        SELECT
            ci.id as id,
            ci.is_deleted as isDeleted,
            ci.gmt_create as gmtCreate,
            ci.creator as creator,
            ci.gmt_modified as gmtModified,
            ci.modifier as modifier,
            ci.shop_id as shopId,
            ci.customer_id as customerId,
            ci.customer_car_id as customerCarId,
            ci.customer_name as customerName,
            ci.mobile as mobile,
            ci.car_license as carLicense,
            ci.contact_name as contactName,
            ci.contact_mobile as contactMobile,
            ci.car_brand_id as carBrandId,
            ci.car_brand as carBrand,
            ci.car_series_id as carSeriesId,
            ci.car_series as carSeries,
            ci.car_level as carLevel,
            ci.last_pay_time as lastPayTime,
            ci.car_model_id as carModelId,
            ci.car_model as carModel,
            ci.total_amount as totalAmount,
            ci.total_number as totalNumber,
            ci.car_level_tag as carLevelTag,
            ci.appoint_id as appointId,
            ci.appoint_create_time as appointCreateTime,
            ci.appoint_time as appointTime,
            ci.appoint_content as appointContent,
            ci.mileage as mileage,
            ci.note_keepup_time as noteKeepupTime,
            ci.note_insurance_time as noteInsuranceTime,
            ci.note_auditing_time as noteAuditingTime,
            ci.note_visit_time as noteVisitTime,
            ci.birthday as birthday
        FROM
        (
        SELECT DISTINCT(customer_car_id) FROM legend_order_info WHERE order_status = 'DDYFK'
        <if test="shopId!= null">
            and shop_id = #{shopId}
        </if>
        <if test="sTime!= null">
            <![CDATA[
              and date(confirm_time) >= date(#{sTime})
            ]]>
        </if>
        <if test="eTime!= null">
            <![CDATA[
              and date(confirm_time) <= date(#{eTime})
            ]]>
        </if>
        ) pl
        LEFT JOIN
        cube_customer_info ci
        ON
        ci.customer_car_id = pl.customer_car_id
        WHERE
        ci.is_deleted = 'N'
        <if test="shopId!= null">
            and ci.shop_id = #{shopId}
        </if>
        <if test="totalNumber!= null">
            and ci.total_number = #{totalNumber}
        </if>
        <if test="minTotalNumber!= null">
            <![CDATA[
              and ci.total_number >= #{minTotalNumber}
            ]]>
        </if>
        <if test="maxTotalNumber!= null">
            <![CDATA[
              and ci.total_number < #{maxTotalNumber}
            ]]>
        </if>
        <if test="carLevelTag!= null">
            and ci.car_level_tag = #{carLevelTag}
        </if>
        <include refid="COMMON.ORDER_BY"/>
        <include refid="COMMON.LIMIT"/>
    </select>

    <!--获取需要提醒的客户信息-->
    <select id="selectCustomerInfoIsNote" resultMap="BaseResultMap">
        select
        <include refid="BaseColumnList"/>
        from cube_customer_info
        where is_deleted = 'N'
        <if test="shopId!= null">
            and shop_id = #{shopId}
        </if>
        <if test="customerCarId!= null">
            and customer_car_id = #{customerCarId}
        </if>
        <if test="noteInsuranceTimeGt!= null">
            <![CDATA[
            and note_insurance_time >= #{noteInsuranceTimeGt}
            ]]>
        </if>
        <if test="noteInsuranceTimeLt!= null">
            <![CDATA[
            and note_insurance_time <= #{noteInsuranceTimeLt}
            ]]>
        </if>
        <if test="noteAuditingTimeGt!= null">
            <![CDATA[
            and note_auditing_time >= #{noteAuditingTimeGt}
            ]]>
        </if>
        <if test="noteAuditingTimeLt!= null">
            <![CDATA[
            and note_auditing_time <= #{noteAuditingTimeLt}
            ]]>
        </if>
        <if test="noteVisitTimeGt!= null">
            <![CDATA[
            and note_visit_time >= #{noteVisitTimeGt}
            ]]>
        </if>
        <if test="noteVisitTimeLt!= null">
            <![CDATA[
            and note_visit_time <= #{noteVisitTimeLt}
            ]]>
        </if>
        <if test="birthdayGt!= null">
            <![CDATA[
            and birthday >= #{birthdayGt}
            ]]>
        </if>
        <if test="birthdayLt!= null">
            <![CDATA[
            and birthday <= #{birthdayLt}
            ]]>
        </if>
        <if test="appointTimeGt!= null">
            <![CDATA[
            and appoint_time >= #{appointTimeGt}
            ]]>
        </if>
        <if test="appointTimeLt!= null">
            <![CDATA[
            and appoint_time <= #{appointTimeLt}
            ]]>
        </if>
        <if test="lostCustomerTimeGt!= null">
            <![CDATA[
            and last_pay_time >= #{lostCustomerTimeGt}
            ]]>
        </if>
        <if test="lostCustomerTimeLt!= null">
            <![CDATA[
            and last_pay_time <= #{lostCustomerTimeLt}
            ]]>
        </if>
        <if test="noteKeepupTimeGt!= null">
            <![CDATA[
            and note_keepup_time >= #{noteKeepupTimeGt}
            ]]>
        </if>
        <if test="noteKeepupTimeLt!= null">
            <![CDATA[
            and note_keepup_time <= #{noteKeepupTimeLt}
            ]]>
        </if>

        <include refid="COMMON.ORDER_BY"/>
        <include refid="COMMON.LIMIT"/>
    </select>

    <select id="selectAccurate" resultMap="BaseResultMap">
        SELECT
        ci.id as id,
        ci.is_deleted as isDeleted,
        ci.gmt_create as gmtCreate,
        ci.creator as creator,
        ci.gmt_modified as gmtModified,
        ci.modifier as modifier,
        ci.shop_id as shopId,
        ci.customer_id as customerId,
        ci.customer_car_id as customerCarId,
        ci.car_license as carLicense,
        ci.customer_name as customerName,
        ci.mobile as mobile,
        ci.contact_name as contactName,
        ci.contact_mobile as contactMobile,
        ci.car_brand_id as carBrandId,
        ci.car_brand as carBrand,
        ci.car_series_id as carSeriesId,
        ci.car_series as carSeries,
        ci.car_level as carLevel,
        ci.last_pay_time as lastPayTime,
        ci.car_model_id as carModelId,
        ci.car_model as carModel,
        ci.total_amount as totalAmount,
        ci.total_number as totalNumber,
        ci.car_level_tag as carLevelTag,
        ci.appoint_create_time as appointCreateTime,
        ci.appoint_time as appointTime,
        ci.appoint_content as appointContent,
        ci.mileage as mileage,
        ci.note_keepup_time as noteKeepupTime,
        ci.note_insurance_time as noteInsuranceTime,
        ci.note_auditing_time as noteAuditingTime,
        ci.note_visit_time as noteVisitTime,
        ci.birthday as birthday
        FROM
        (
        SELECT customer_car_id,
            sum(pay_amount) as total_amount ,
            count(id) as total_number
        FROM legend_order_info WHERE order_status = 'DDYFK'
        <if test="shopId!= null">
            and shop_id = #{shopId}
        </if>
        <if test="sTime!= null">
            <![CDATA[
              and date(confirm_time) >= date(#{sTime})
            ]]>
        </if>
        <if test="eTime!= null">
            <![CDATA[
              and date(confirm_time) <= date(#{eTime})
            ]]>
        </if>
        GROUP BY customer_car_id
        ) pl
        LEFT JOIN
        cube_customer_info ci
        ON
        ci.customer_car_id = pl.customer_car_id
        WHERE
        ci.is_deleted = 'N'
        <if test="shopId!= null">
            and ci.shop_id = #{shopId}
        </if>
        <if test="totalNumber!= null">
            and ci.total_number = #{totalNumber}
        </if>
        <if test="minTotalNumber!= null">
            <![CDATA[
              and ci.total_number >= #{minTotalNumber}
            ]]>
        </if>
        <if test="carLevelTag!= null">
            and ci.car_level_tag = #{carLevelTag}
        </if>
        <if test="minAmount!= null">
            <![CDATA[
              and pl.total_amount >= #{minAmount}
            ]]>
        </if>
        <if test="maxAmount!= null">
            <![CDATA[
              and pl.total_amount <= #{maxAmount}
            ]]>
        </if>
        <if test="minAverage!= null">
            <![CDATA[
              and pl.total_amount/pl.total_number >= #{minAverage}
            ]]>
        </if>
        <if test="maxAverage!= null">
            <![CDATA[
              and pl.total_amount/pl.total_number <= #{maxAverage}
            ]]>
        </if>
        <if test="numberSign!= null and number != null">
            <![CDATA[
              and pl.total_number ${numberSign} #{number}
            ]]>
        </if>
        <if test="carLicense!= null">
            and ci.car_license = #{carLicense}
        </if>
        <if test="mobile!= null">
            and ci.mobile = #{mobile}
        </if>
        <if test="minMileage!= null">
            <![CDATA[
              and ci.mileage >= #{minMileage}
            ]]>
        </if>
        <if test="maxMileage!= null">
            <![CDATA[
              and ci.mileage <= #{maxMileage}
            ]]>
        </if>
        <if test="allot != null">
            and ci.user_id=0
        </if>
        <include refid="COMMON.ORDER_BY"/>
        <include refid="COMMON.LIMIT"/>
    </select>

    <select id="selectAccurateWithCardInfo" resultMap="BaseResultMap">
        SELECT
        ci.id as id,
        ci.is_deleted as isDeleted,
        ci.gmt_create as gmtCreate,
        ci.creator as creator,
        ci.gmt_modified as gmtModified,
        ci.modifier as modifier,
        ci.shop_id as shopId,
        ci.customer_id as customerId,
        ci.customer_car_id as customerCarId,
        ci.car_license as carLicense,
        ci.customer_name as customerName,
        ci.mobile as mobile,
        ci.contact_name as contactName,
        ci.contact_mobile as contactMobile,
        ci.car_brand_id as carBrandId,
        ci.car_brand as carBrand,
        ci.car_series_id as carSeriesId,
        ci.car_series as carSeries,
        ci.car_level as carLevel,
        ci.last_pay_time as lastPayTime,
        ci.car_model_id as carModelId,
        ci.car_model as carModel,
        ci.total_amount as totalAmount,
        ci.total_number as totalNumber,
        ci.car_level_tag as carLevelTag,
        ci.appoint_create_time as appointCreateTime,
        ci.appoint_time as appointTime,
        ci.appoint_content as appointContent,
        ci.mileage as mileage,
        ci.note_keepup_time as noteKeepupTime,
        ci.note_insurance_time as noteInsuranceTime,
        ci.note_auditing_time as noteAuditingTime,
        ci.note_visit_time as noteVisitTime,
        ci.birthday as birthday
        FROM
        (
        SELECT customer_car_id,
        sum(pay_amount) as total_amount ,
        count(id) as total_number
        FROM legend_order_info WHERE order_status = 'DDYFK'
        <if test="shopId!= null">
            and shop_id = #{shopId}
        </if>
        <if test="sTime!= null">
            <![CDATA[
              and date(confirm_time) >= date(#{sTime})
            ]]>
        </if>
        <if test="eTime!= null">
            <![CDATA[
              and date(confirm_time) <= date(#{eTime})
            ]]>
        </if>
        GROUP BY customer_car_id
        ) pl
        LEFT JOIN
        cube_customer_info ci
        ON
        ci.customer_car_id = pl.customer_car_id
        <if test="memberLevelId != null">
        JOIN
          (select customer_id from legend_account_info
          WHERE id in (
            SELECT account_id
            FROM legend_member_card
            WHERE shop_id = #{shopId}
            AND card_type_id = #{memberLevelId}
            AND is_deleted = 'N'
            and expire_date >= now()
          )
        ) ai on ai.customer_id = ci.customer_id
        </if>
        WHERE
        ci.is_deleted = 'N'
        <if test="shopId!= null">
            and ci.shop_id = #{shopId}
        </if>
        <if test="totalNumber!= null">
            and ci.total_number = #{totalNumber}
        </if>
        <if test="minTotalNumber!= null">
            <![CDATA[
              and ci.total_number >= #{minTotalNumber}
            ]]>
        </if>
        <if test="carLevelTag!= null">
            and ci.car_level_tag = #{carLevelTag}
        </if>
        <if test="minAmount!= null">
            <![CDATA[
              and pl.total_amount >= #{minAmount}
            ]]>
        </if>
        <if test="maxAmount!= null">
            <![CDATA[
              and pl.total_amount <= #{maxAmount}
            ]]>
        </if>
        <if test="minAverage!= null">
            <![CDATA[
              and pl.total_amount/pl.total_number >= #{minAverage}
            ]]>
        </if>
        <if test="maxAverage!= null">
            <![CDATA[
              and pl.total_amount/pl.total_number <= #{maxAverage}
            ]]>
        </if>
        <if test="numberSign!= null and number != null">
            <![CDATA[
              and pl.total_number ${numberSign} #{number}
            ]]>
        </if>
        <if test="carLicense!= null">
            and ci.car_license = #{carLicense}
        </if>
        <if test="mobile!= null">
            and ci.mobile = #{mobile}
        </if>
        <if test="minMileage!= null">
            <![CDATA[
              and ci.mileage >= #{minMileage}
            ]]>
        </if>
        <if test="maxMileage!= null">
            <![CDATA[
              and ci.mileage <= #{maxMileage}
            ]]>
        </if>
        <if test="allot != null">
            and ci.user_id=0
        </if>
        <include refid="COMMON.ORDER_BY"/>
        <include refid="COMMON.LIMIT"/>
    </select>

    <select id="selectAccurateCount" resultType="java.lang.Integer">
        SELECT
          count(DISTINCT ci.id)
        FROM
        (
        SELECT customer_car_id,
        sum(pay_amount) as total_amount ,
        count(id) as total_number
        FROM legend_order_info WHERE order_status = 'DDYFK'
        <if test="shopId!= null">
            and shop_id = #{shopId}
        </if>
        <if test="sTime!= null">
            <![CDATA[
              and date(confirm_time) >= date(#{sTime})
            ]]>
        </if>
        <if test="eTime!= null">
            <![CDATA[
              and date(confirm_time) <= date(#{eTime})
            ]]>
        </if>
        GROUP BY customer_car_id
        ) pl
        LEFT JOIN
        cube_customer_info ci
        ON
        ci.customer_car_id = pl.customer_car_id
        <if test="memberLevelId != null">
            join legend_account_info ai
            on ai.customer_id = ci.customer_id and ai.shop_id = #{shopId}
            join legend_member_card mc
            on mc.account_id = ai.id and mc.shop_id = #{shopId}
            and mc.card_type_id = #{memberLevelId}
            and mc.expire_date >= now()
        </if>
        WHERE
        ci.is_deleted = 'N'
        <if test="shopId!= null">
            and ci.shop_id = #{shopId}
        </if>
        <if test="totalNumber!= null">
            and ci.total_number = #{totalNumber}
        </if>
        <if test="minTotalNumber!= null">
            <![CDATA[
              and ci.total_number >= #{minTotalNumber}
            ]]>
        </if>
        <if test="carLevelTag!= null">
            and ci.car_level_tag = #{carLevelTag}
        </if>
        <if test="minAmount!= null">
            <![CDATA[
              and pl.total_amount >= #{minAmount}
            ]]>
        </if>
        <if test="maxAmount!= null">
            <![CDATA[
              and pl.total_amount <= #{maxAmount}
            ]]>
        </if>
        <if test="minAverage!= null">
            <![CDATA[
              and pl.total_amount/pl.total_number >= #{minAverage}
            ]]>
        </if>
        <if test="maxAverage!= null">
            <![CDATA[
              and pl.total_amount/pl.total_number <= #{maxAverage}
            ]]>
        </if>
        <if test="numberSign!= null and number != null">
            <![CDATA[
              and pl.total_number ${numberSign} #{number}
            ]]>
        </if>
        <if test="carLicense!= null">
            and ci.car_license = #{carLicense}
        </if>
        <if test="mobile!= null">
            and ci.mobile = #{mobile}
        </if>
        <if test="minMileage!= null">
            <![CDATA[
              and ci.mileage >= #{minMileage}
            ]]>
        </if>
        <if test="maxMileage!= null">
            <![CDATA[
              and ci.mileage <= #{maxMileage}
            ]]>
        </if>
        <if test="allot != null">
            and ci.user_id=0
        </if>
    </select>

    <!--客情维护-->
    <select id="getCountOfCustomerInfo" resultType="java.lang.Integer">
        select
        count(id)
        from cube_customer_info
        where is_deleted = 'N'
        and shop_id = #{shopId}
        and customer_car_id in
        <foreach collection="carIds" item="tag" open="(" separator=","  close=")">
            #{tag}
        </foreach>
        <include refid="COMMON.ORDER_BY"/>
        <include refid="COMMON.LIMIT"/>
    </select>

    <select id="getCustomerInfoList" resultMap="BaseResultMap">
        select
        <include refid="BaseColumnList"/>
        from cube_customer_info
        where is_deleted = 'N'
        and shop_id = #{shopId}
        and customer_car_id in
        <foreach collection="carIds" item="tag" open="(" separator=","  close=")">
            #{tag}
        </foreach>
        <include refid="COMMON.ORDER_BY"/>
        <include refid="COMMON.LIMIT"/>
    </select>


    <select id="getCustomerInfoListFilterTimeIsNull" resultMap="BaseResultMap">
        select
        <include refid="BaseColumnList"/>
        from cube_customer_info
        where is_deleted = 'N'
        and shop_id = #{shopId}
        and customer_car_id in
        <foreach collection="carIds" item="tag" open="(" separator=","  close=")">
            #{tag}
        </foreach>
        <if test="noteType != null &amp;&amp; noteType == 0">
            and appoint_time IS  NOT NULL
        </if>
        <if test="noteType != null &amp;&amp; noteType == 1">
            and note_keepup_time IS  NOT NULL
        </if>
        <if test="noteType != null &amp;&amp; noteType == 2">
            and note_insurance_time IS  NOT NULL
        </if>
        <if test="noteType != null &amp;&amp; noteType == 3">
            and note_auditing_time IS  NOT NULL
        </if>
        <if test="noteType != null &amp;&amp; noteType == 5">
            and birthday IS  NOT NULL
        </if>
        <if test="noteType != null &amp;&amp; noteType == 6">
            and last_pay_time IS  NOT NULL
        </if>
    </select>
    <select id="selectCountByCustomerTag" resultType="java.lang.Integer">
        SELECT 	count(1)
        FROM
            (
                SELECT customer_car_id, tag_name
                FROM legend_customer_tag
                WHERE 1=1
                and shop_id = #{shopId}
                and tag_name = #{customerTag}
                and is_deleted = 'N'
            ) a
            JOIN
                cube_customer_info b
            ON  a.customer_car_id = b.customer_car_id
      WHERE 1=1
      <if test="allot != null" >
        AND b.user_id = 0
      </if>
    </select>
    <select id="selectByCustomerTag" resultType="com.tqmall.legend.entity.marketing.ng.CustomerInfo">
        SELECT
                b.customer_car_id as customerCarId,
                b.car_license as carLicense,
                b.customer_name as customerName,
                b.mobile as mobile,
                b.car_brand as carBrand,
                b.car_series as carSeries,
                b.car_model as carModel,
                a.tag_name as customerTag
        FROM
            (
                SELECT customer_car_id, tag_name
                FROM legend_customer_tag
                WHERE 1=1
                and shop_id = #{shopId}
                and tag_name = #{customerTag}
                and is_deleted = 'N'
            ) a
            JOIN
                cube_customer_info b
            ON  a.customer_car_id = b.customer_car_id
        WHERE 1=1
        <if test="allot != null" >
            AND b.user_id = 0
        </if>
        <if test = "offset != null and limit != null">
            limit ${offset}, ${limit}
        </if>
    </select>

    <select id="selectCountByCustomerCompany" resultType="java.lang.Integer">
        SELECT count(1)
        FROM
          (SELECT id
           FROM legend_customer
           WHERE is_deleted='N'
             AND shop_id = #{shopId}
             AND company LIKE concat('%',#{customerCompany},'%')) a
        JOIN cube_customer_info b ON a.id = b.customer_id
        WHERE b.is_deleted='N'
          AND b.shop_id=#{shopId}
        <if test="allot != null" >
            AND b.user_id = 0
        </if>
    </select>
    <select id="selectByCustomerCompany" resultType="com.tqmall.legend.entity.marketing.ng.CustomerInfo">
        SELECT b.customer_car_id AS customerCarId,
               b.car_license AS carLicense,
               b.customer_name AS customerName,
               b.mobile AS mobile,
               b.car_brand AS carBrand,
               b.car_series AS carSeries,
               b.car_model AS carModel,
               a.company AS customerCompany
        FROM
          (SELECT id,
                  company
           FROM legend_customer
           WHERE is_deleted='N'
             AND shop_id = #{shopId}
             AND company LIKE concat('%',#{customerCompany},'%')) a
        JOIN cube_customer_info b ON a.id = b.customer_id
        WHERE b.is_deleted='N'
          AND b.shop_id=#{shopId}
          <if test="allot != null" >
            AND b.user_id = 0
          </if>
        <if test = "offset != null and limit != null">
            limit ${offset}, ${limit}
        </if>
    </select>

    <select id="listByCarIds" resultMap="BaseResultMap">
        select
        <include refid="BaseColumnList"/>
        from cube_customer_info
        WHERE shop_id = #{shopId} and is_deleted='N'
        and customer_car_id in (
        <foreach collection="carIds" item="item" separator=",">
            #{item}
        </foreach>
        )
    </select>


</mapper>
