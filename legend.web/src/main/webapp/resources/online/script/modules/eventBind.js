/*-- 淘汽云修 2016-03-09 04:48:56 --*/
define(function(require,exports,module){var check=require("./check"),cascadeSelect=require("./cascadeSelect"),chosen=require("./chosenSelect"),dialog=require("./dialog"),ajax=require("./ajax"),artTemplate=require("../libs/artTemplate/artTemplate");$(function(){$(document).on("click",".qxy_add_icon",function(){var a=$(this).parents(".form_item"),b=$(this).parents(".form_row"),c=$("input[name=maxCol]",a).val();if(c&&Number(c)>0){var d=a.siblings(".form_item").size();if(d+1>=c)return void dialog.info("最多只能加"+c+"条",3)}if(a[0]){var e=a[0].outerHTML;$(this).removeClass("qxy_add_icon").addClass("qxy_del_icon"),a.after(e),a.next(".form_item").find("input[type='hidden'][clearable]").val(""),a.next(".form_item").find(".cascadeSelect").each(function(a,b){cascadeSelect.init(b)}),a.next(".form_item").find(".chosen").each(function(a,b){chosen.handleChoosenSelect(b)});var f=a.find("[num]").text();if(a.next(".form_item").find("[num]").text(++f),a.width()<b.width()){var g=$(".form_item",b).index(a.next())+1,h=Math.floor(b.width()/a.width()),i=$(".form_item:eq(0)",b).css("margin-right");g%h==0?a.next().css("margin-right",0):a.next().css("margin-right",i)}a.next().find(".part-info").remove(),a.next().find(".qxy_err_msg").hide()}}),$(document).on("click",".qxy_del_icon",function(){var $this=$(this),formItem=$this.parents(".form_item"),formRow=$this.parents(".form_row"),delFn=formItem.attr("dynamic_fn")||formItem.attr("del_fn"),delBeforeFn=formItem.attr("del_before_fn"),next=formItem.next(),flag=!0;delBeforeFn&&(delBeforeFn=eval(delBeforeFn),flag=delBeforeFn(formItem)),flag&&(formItem.nextAll().each(function(){var a=$(this).find("[num]"),b=a.text();a.text(b-1)}),formItem.remove(),delFn&&(delFn=eval(delFn))(next),formItem.width()<formRow.width()&&$(".form_item",formRow).each(function(){var a=$(this).index()+1,b=Math.floor(formRow.width()/formItem.width()),c=$(".form_item:eq(0)",formRow).css("margin-right");a%b==0?$(this).css("margin-right",0):$(this).css("margin-right",c)}))}),$(document).on("keypress","div[dynamic_id] input:not([service_url])",function(a){"13"==a.keyCode&&$(a.target).parents(".form_row").find(".qxy_add_icon").trigger("click")}),$(document).on("click",".qxy_btn[ref_form_op]",function(){var a=$(this),b=a.attr("ref_form_op");b&&actionList[b]&&"function"==typeof actionList[b]&&actionList[b](a)}),$(document).on("focus",".qxy_picker",function(){var a=require("./../libs/My97DatePicker/WdatePicker"),b=$(this).attr("format")||"yyyy-MM-dd",c=$(this).attr("min")||"",d=$(this).attr("max")||"",e=$(this).attr("pairs")||!1,f={dateFmt:b,minDate:c,maxDate:d,doubleCalendar:e};a.wp(f)}),$(document).on("click",".qxy_group_slider >.group_head",function(){var a=$("i",$(this)),b=a.attr("class"),c=$(this).next(".group_content");b&&("arrow_down"==b?(a.attr("class","arrow_up"),c.show(),formLayoutCalc(c)):(a.attr("class","arrow_down"),c.hide(),$(".xubox_layer[type='tips']",c).remove()))}),$(document).on("click",".downward",function(){var a=$(this),b=a.parent();$(".hide_part",b).show(),formLayoutCalc($(".hide_part",b)),chosen.handleChoosenSelect($(".chosen",b)),$(this).hasClass("search_form_slide_btn")?a.html("高级搜索<i></i>"):a.html("隐藏更多<i></i>"),a.addClass("upward").removeClass("downward")}),$(document).on("click",".upward",function(){var a=$(this),b=a.parent();$(".hide_part",b).hide(),$(this).hasClass("search_form_slide_btn")?a.html("高级搜索<i></i>"):a.html("显示更多<i></i>"),a.addClass("downward").removeClass("upward")}),$("input[v_type]").each(function(a){var b=$(this),c=JSON.parse(b.attr("v_type"));return c.vurl?(b.data("data",b.val()),b.data("vurl",c.vurl),delete c.vurl,b.attr("v_type",JSON.stringify(c)),void b.on("keyup",function(){var a=$(this).val(),c=$(this).data("data");if(c==a){var d=JSON.parse(b.attr("v_type"));b.data("vurl",d.vurl),delete d.vurl,b.attr("v_type",JSON.stringify(d))}else{var d=JSON.parse(b.attr("v_type")),e=$(this).data("vurl");d=$.extend(d,{vurl:e}),b.attr("v_type",JSON.stringify(d))}})):!0}),$(document).on("keyup",".J_input_limit",function(){var a=$(this),b=a.data("limit_type"),c=a.val(),d="";"number"===b&&(d=c.replace(/[^0-9]/g,""),d!==c&&a.val(d)),"price"===b&&(d=c.replace(/[^0-9.]/g,""),d=d.replace(/^\.+/g,""),d!==c&&a.val(d)),"digits_letters"===b&&(d=c.replace(/[^0-9a-z]/gi,""),d!==c&&a.val(d)),"phone"===b&&(d=c.replace(/[^0-9-]/gi,""),d!==c&&a.val(d)),"account"===b&&(d=c.replace(/[^0-9\-]/gi,""),d!==c&&a.val(d)),"zh"===b&&(d=c.replace(/[\u4E00-\u9FA5]/gi,""),console.log(d),d!==c&&a.val(d))}),$(document).on("mouseover",".icon_tips",function(a){var b=$(this),c=".tips_content",d=".tips_content_inner",e=b.parent(),f=$(c,e),g=$(d,e),h=$("i",g);if(f.is(":visible"))return!1;h.size()<=0&&g.append("<i></i>");var i=b.offset();f.toggle();var j=f.height(),k=f.width(),l=$(window).width();i.left+k+30>l?(i.left-=k+40,$("i",g).removeClass("before").addClass("after")):$("i",g).removeClass("after").addClass("before"),f.css({left:i.left+30,top:i.top,"margin-top":-(j/2)+14}).show()}),$(document).on("mouseout",".icon_tips",function(){var a=$(this),b=".tips_content",c=a.parent();$(b,c).hide()}),check.init(),check.bind()});var actionList={submit:function(a){var b=require("./ajax"),c=require("./formData"),d=require("./dialog"),e=a.attr("ref_form_id"),f=$("#"+e),g=c.get(e),h=check.check("#"+e);if(h){var i=f.attr("method")||"post",j={url:f.attr("action"),data:g,loadText:"正在保存信息中...",success:function(a){a.success?(d.info("操作成功",1),window.location.href=document.referrer):d.info(a.errorMsg,3)}};"post"==i?b.post(j):b.get(j)}},back:function(){window.location.href=document.referrer}}});