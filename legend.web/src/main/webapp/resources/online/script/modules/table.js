/*-- 淘汽云修 2016-03-09 04:48:56 --*/
define(function(require,exports,module){var ajaxModule=require("./ajax"),formModule=require("./formData"),template=require("./../libs/artTemplate/artTemplate"),pageModule=require("./paging"),dialogModule=require("./dialog"),checkModule=require("./check");exports.fill=function(args){var table;table="object"==typeof args?$("#"+args.tableid):$("#"+args);var formid=table.attr("ref_search_form_id"),form=$("form:eq(0)",$("#"+formid)),method=form.attr("method"),serviceUrl=form.attr("action")||table.attr("service_url"),datas=formModule.get(formid),tpl=$("script[type='text/html']",table).html(),callback=table.attr("callback_fn"),autoLoad=table.attr("auto_load");"object"==typeof args&&args.data&&(datas=$.extend(datas,args.data)),form.off("click",".search_btn").on("click",".search_btn",function(){checkModule.check("#"+formid)&&(method&&"post"==method?ajaxModule.post({url:serviceUrl,data:$.extend(formModule.get(formid),{page:1}),success:success}):ajaxModule.get({url:serviceUrl,data:$.extend(formModule.get(formid),{page:1}),success:success}))}),form.on("keydown",function(a){return 13==a.keyCode?($(".search_btn").trigger("click"),!1):void 0}),table.off("click").on("click",".data_del",function(){var a=$(this).attr("id_value"),b=$(this).attr("service_url");dialogModule.confirm("确认删除？",function(){ajaxModule.post({url:b,data:{id:a},loadText:"正在删除中...",success:function(a){var b=$("span.current",table).text();a.success?dialogModule.info("删除成功",1,2,function(){ajaxModule.get({url:serviceUrl,data:$.extend({page:b},formModule.get(formid)),success:success})},!0):dialogModule.info(a.errorMsg,3)}})})}),template.helper("$jsonToString",function(a){return JSON.stringify(a)}),template.helper("$dateFormat",function(a,b){a=new Date(a);var c={M:a.getMonth()+1,d:a.getDate(),h:a.getHours(),m:a.getMinutes(),s:a.getSeconds(),q:Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()};return b=b.replace(/([yMdhmsqS])+/g,function(b,d){var e=c[d];return void 0!==e?(b.length>1&&(e="0"+e,e=e.substr(e.length-2)),e):"y"===d?(a.getFullYear()+"").substr(4-b.length):b})}),template.helper("$substr",function(a,b){return null==a?"":!a||a.length<=b?a:a.substr(0,b)+"..."});var success=function(json){if(json.success&&null!=json.data){var current=json.data.number+1;if(json.data.content&&0==json.data.content.length&&1!=current)return current=1,location.hash=1,void backFn(current);isNaN(current)||(location.hash=current);var temp=template.compile(tpl),html=temp({templateData:json});if($(".table_content",table).html(html),checkModule.init(),pageModule.init({dom:table,itemSize:json.data.totalElements,pageCount:json.data.totalPages,current:current,backFn:function(a){backFn(a)}}),callback)try{eval(callback)(json,tpl)}catch(e){console.error("没找到表格的回调方法")}args.callback&&args.callback()}else $(".table_content",table).html(""),pageModule.init({dom:table,itemSize:0,pageCount:0,current:current,backFn:function(a){backFn(a)}}),dialogModule.info(json.errorMsg,3)},hashPage=location.hash,pageNum=1;""==hashPage?(pageNum=1,location.hash=pageNum):pageNum=hashPage.substr(1);var backFn=function(a){var b=$(".table_content").offset().top;$(document).scrollTop(b-80),ajaxModule.get({url:serviceUrl,data:$.extend({page:a},formModule.get(formid)),success:success})};autoLoad&&"true"==autoLoad&&(method&&"post"==method?ajaxModule.post({url:serviceUrl,data:$.extend({page:pageNum},datas),success:success}):ajaxModule.get({url:serviceUrl,data:$.extend({page:pageNum},datas),success:success}))}});