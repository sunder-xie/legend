/*-- 淘汽云修 2016-03-09 04:48:56 --*/
define(function(require,exports,module){var ajax=require("./ajax"),tpl=require("./../libs/artTemplate/artTemplate"),dialog=require("./dialog"),list=".qxy_input_downlist",li=".list_content li",timer=null,speed=0,low_ie=util.isLowIE().isLowIE,getHtml=function(a,b){var c,d=a.siblings('script[type="text/html"]')||[];if(d.size()<1){var e=JSON.parse(a.attr("data_cols")),f=0,g=0;for(var h in e)f++;if(e.width){for(var i=0;i<e.width.length;i++)g+=e.width[i];f-=1}c=['<div class="qxy_input_downlist"'+(e.width?"":'style="width:'+150*f+'px"')+">",'<ul class="list_title">',"<% var index=0; %>","<li "+(e.width?'style="width:'+g+'px"':"")+"><% for(var name in dataColsJson){ %>",'<% if(name == "width") {continue;} %>','<b style="width:','<%= (dataColsJson["width"] && dataColsJson["width"][index]+"px;") || ~~(100/dataColsLen) + "%;" %>">',"<%= dataColsJson[name]%></b>","<% index++ %>","<%}%></li>","</ul>",'<ul class="list_content">',"<%for(var i=0;i<templateData.length;i++){","var item = templateData[i];","%>","<% index=0; %>","<li><% for(var name in dataColsJson){ %>",'<% if(name == "width") {continue;} %>','<span style="width:','<%= (dataColsJson["width"] && dataColsJson["width"][index]+"px;") || ~~(100/dataColsLen) + "%;" %>">',"<%= item[name]%></span>","<% index++ %>","<%}%></li>","<%}%>","</ul>","</div>"].join("");var j=tpl.compile(c),k=j({templateData:b,dataColsJson:e,dataColsLen:f});return k}c=d.html();var j=tpl.compile(c),k=j({templateData:b});return k};$("body").on("click","input[service_url]",function(e){var $this=$(this),url=$this.attr("service_url"),showName=$this.attr("name"),showKey=$this.attr("show_key"),hiddenName=$this.attr("hidden_name"),hiddenKey=$this.attr("hidden_key"),searchKey=$this.attr("search_key"),remote=$this.attr("remote")||!1,callbacks=$this.attr("callback_fn");searchKey=searchKey&&searchKey.split(","),callbacks=eval(callbacks);var queueNum=0,successFnNum=0,ajaxReq=function(a){++queueNum,ajax.get({url:url,data:a,cache:!0,beforeSend:beforeSend,loadShow:!1,success:function(a){++successFnNum,queueNum==successFnNum&&success(a)}})},keyupQuery=function(a){null!=timer&&window.clearTimeout(timer),timer=setTimeout(function(){ajaxReq(a)},speed)},clickQuery=function(a){ajaxReq(a)},beforeSend=function(){},getDatas=function(a){var b={},c=$this.attr("ext_data"),d=$this.parents(".form_item");if(0==d.size()&&(d=$this.parents("tr")),c){c=c.split(",");for(var e=0;e<c.length;e++)b[a[e]]=$("[name = '"+c[e]+"']",d).val();return b}if(1==a.length)return b[a[0]]=$this.val(),b;for(var e=0;e<a.length;e++){var f=$.trim($("[name='"+a[e]+"']",d).val());b[a[e]]=f}return b},success=function(a){$this.siblings('script[type="text/html"]')||[];if(colseList(),0!=a.success){$this.data("listData",a.data),$this.after(getHtml($this,a.data)),$this.next(list).css({"min-width":$this.outerWidth()-2});var b=$(".qxy_add_btn",list);$(li,list).size()<=0&&b.size()<1&&colseList(),$(li,list).each(function(b){$(this).data("itemData",a.data[b])}),$(document).off("click",li).on("click",li,function(){enterLi($(this))})}},enterLi=function(a){var b=a.data("itemData"),c=a.parents(list),d=$this.parents(".form_item");0==d.size()&&(d=$this.parents("tr")),c.siblings("input[name='"+showName+"']").val(b[showKey]).blur(),c.siblings("input[name='"+hiddenName+"']").val(b[hiddenKey]),"function"==typeof callbacks&&callbacks($this,b,d)};colseList(),e.stopPropagation(),clickQuery(getDatas(searchKey));var current=0;$this.off("keyup").on("keyup",function(a){var b=$(li).size(),c=$(li).eq(0).height();switch(a.keyCode){case 38:current-=1,0>=current&&(current=b),$(li).eq(current-1).addClass("current").siblings().removeClass("current"),$(".list_content",list).scrollTop(current*c);break;case 40:current>=b&&(current=0),$(li).eq(current).addClass("current").siblings().removeClass("current"),$(".list_content",list).scrollTop(current*c),current+=1;break;case 13:$(list).size()>0?($("li.current",list).size()>0&&enterLi($("li.current",list)),colseList()):(keyupQuery(getDatas(searchKey)),current=0);break;default:keyupQuery(getDatas(searchKey)),current=0}})});var colseList=function(){$(list).remove()};$(document).click(function(){colseList()})});