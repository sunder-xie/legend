/*-- 淘汽云修 2015-12-07 03:32:29 --*/
define(function(require,exports,a){return function(a){!function(a){var b={init:function(c){return this.each(function(){var d=a(this);d.data("uploadifive",{inputs:{},inputCount:0,fileID:0,queue:{count:0,selected:0,replaced:0,errors:0,queued:0,cancelled:0},uploads:{current:0,attempts:0,successful:0,errors:0,count:0}});var e=d.data("uploadifive"),f=e.settings=a.extend({auto:!0,buttonClass:!1,buttonText:"Select Files",checkScript:!1,dnd:!0,dropTarget:!1,fileObjName:"Filedata",fileSizeLimit:0,fileType:!1,formData:{},height:30,itemTemplate:!1,method:"post",multi:!0,overrideEvents:[],queueID:!1,queueSizeLimit:0,removeCompleted:!1,simUploadLimit:0,truncateLength:0,uploadLimit:0,uploadScript:"uploadifive.php",width:100},c);if(isNaN(f.fileSizeLimit)){var g=1.024*parseInt(f.fileSizeLimit);f.fileSizeLimit.indexOf("KB")>-1?f.fileSizeLimit=1e3*g:f.fileSizeLimit.indexOf("MB")>-1?f.fileSizeLimit=1e6*g:f.fileSizeLimit.indexOf("GB")>-1&&(f.fileSizeLimit=1e9*g)}else f.fileSizeLimit=1024*f.fileSizeLimit;if(e.inputTemplate=a('<input type="file">').css({"font-size":f.height+"px",opacity:0,position:"absolute",right:"-3px",top:"-3px","z-index":9}),e.createInput=function(){var c=e.inputTemplate.clone(),g=c.name="input"+e.inputCount++;f.multi&&c.attr("multiple",!0),f.fileType&&c.attr("accept",f.fileType),c.bind("change",function(){e.queue.selected=0,e.queue.replaced=0,e.queue.errors=0,e.queue.queued=0;var c=this.files.length;if(e.queue.selected=c,e.queue.count+c>f.queueSizeLimit&&0!==f.queueSizeLimit)a.inArray("onError",f.overrideEvents)<0&&alert("The maximum number of queue items has been reached ("+f.queueSizeLimit+").  Please select fewer files."),"function"==typeof f.onError&&f.onError.call(d,"QUEUE_LIMIT_EXCEEDED");else{for(var h=0;c>h;h++)file=this.files[h],e.addQueueItem(file);e.inputs[g]=this,e.createInput()}f.auto&&b.upload.call(d),"function"==typeof f.onSelect&&f.onSelect.call(d,e.queue)}),e.currentInput&&e.currentInput.hide(),e.button.append(c),e.currentInput=c},e.destroyInput=function(b){a(e.inputs[b]).remove(),delete e.inputs[b],e.inputCount--},e.drop=function(c){e.queue.selected=0,e.queue.replaced=0,e.queue.errors=0,e.queue.queued=0;var g=c.dataTransfer,h=g.name="input"+e.inputCount++,i=g.files.length;if(e.queue.selected=i,e.queue.count+i>f.queueSizeLimit&&0!==f.queueSizeLimit)a.inArray("onError",f.overrideEvents)<0&&alert("The maximum number of queue items has been reached ("+f.queueSizeLimit+").  Please select fewer files."),"function"==typeof f.onError&&f.onError.call(d,"QUEUE_LIMIT_EXCEEDED");else{for(var j=0;i>j;j++)file=g.files[j],e.addQueueItem(file);e.inputs[h]=g}f.auto&&b.upload.call(d),"function"==typeof f.onDrop&&f.onDrop.call(d,g.files,g.files.length),c.preventDefault(),c.stopPropagation()},e.fileExistsInQueue=function(a){for(var b in e.inputs){input=e.inputs[b],limit=input.files.length;for(var c=0;c<limit;c++)if(existingFile=input.files[c],existingFile.name==a.name&&!existingFile.complete)return!0}return!1},e.removeExistingFile=function(a){for(var c in e.inputs){input=e.inputs[c],limit=input.files.length;for(var f=0;f<limit;f++)existingFile=input.files[f],existingFile.name!=a.name||existingFile.complete||(e.queue.replaced++,b.cancel.call(d,existingFile,!0))}},0==f.itemTemplate?e.queueItem=a('<div class="uploadifive-queue-item">        		                        <a class="close" href="#">X</a>        		                        <div><span class="filename"></span><span class="fileinfo"></span></div>        		                        <div class="progress">        		                            <div class="progress-bar"></div>        		                        </div>        		                    </div>'):e.queueItem=a(f.itemTemplate),e.addQueueItem=function(c){if(a.inArray("onAddQueueItem",f.overrideEvents)<0){e.removeExistingFile(c),c.queueItem=e.queueItem.clone(),c.queueItem.attr("id",f.id+"-file-"+e.fileID++),c.queueItem.find(".close").bind("click",function(){return b.cancel.call(d,c),!1});var g=c.name;g.length>f.truncateLength&&0!=f.truncateLength&&(g=g.substring(0,f.truncateLength)+"..."),c.queueItem.find(".filename").html(g),c.queueItem.data("file",c),e.queueEl.append(c.queueItem)}"function"==typeof f.onAddQueueItem&&f.onAddQueueItem.call(d,c),c.size>f.fileSizeLimit&&0!=f.fileSizeLimit?e.error("FILE_SIZE_LIMIT_EXCEEDED",c):(e.queue.queued++,e.queue.count++)},e.removeQueueItem=function(b,c,d){d||(d=0);var f=c?0:500;b.queueItem&&(" - Completed"!=b.queueItem.find(".fileinfo").html()&&b.queueItem.find(".fileinfo").html(" - Cancelled"),b.queueItem.find(".progress-bar").width(0),b.queueItem.delay(d).fadeOut(f,function(){a(this).remove()}),delete b.queueItem,e.queue.count--)},e.filesToUpload=function(){var a=0;for(var b in e.inputs){input=e.inputs[b],limit=input.files.length;for(var c=0;c<limit;c++)file=input.files[c],file.skip||file.complete||a++}return a},e.checkExists=function(c){if(a.inArray("onCheck",f.overrideEvents)<0){a.ajaxSetup({async:!1});var e=a.extend(f.formData,{filename:c.name});if(a.post(f.checkScript,e,function(a){c.exists=parseInt(a)}),c.exists&&!confirm("A file named "+c.name+" already exists in the upload folder.\nWould you like to replace it?"))return b.cancel.call(d,c),!0}return"function"==typeof f.onCheck&&f.onCheck.call(d,c,c.exists),!1},e.uploadFile=function(b,c){if(!b.skip&&!b.complete&&!b.uploading)if(b.uploading=!0,e.uploads.current++,e.uploads.attempted++,xhr=b.xhr=new XMLHttpRequest,"function"==typeof FormData||"object"==typeof FormData){var g=new FormData;g.append(f.fileObjName,b);for(i in f.formData)g.append(i,f.formData[i]);xhr.open(f.method,f.uploadScript,!0),xhr.upload.addEventListener("progress",function(a){a.lengthComputable&&e.progress(a,b)},!1),xhr.addEventListener("load",function(a){4==this.readyState&&(b.uploading=!1,200==this.status?"Invalid file type."!==b.xhr.responseText?e.uploadComplete(a,b,c):e.error(b.xhr.responseText,b,c):404==this.status?e.error("404_FILE_NOT_FOUND",b,c):403==this.status?e.error("403_FORBIDDEN",b,c):e.error("Unknown Error",b,c))}),xhr.send(g)}else{var h=new FileReader;h.onload=function(g){var h="-------------------------"+(new Date).getTime(),i="--",j="\r\n",k="";k+=i+h+j,k+='Content-Disposition: form-data; name="'+f.fileObjName+'"',b.name&&(k+='; filename="'+b.name+'"'),k+=j,k+="Content-Type: application/octet-stream"+j+j,k+=g.target.result+j;for(key in f.formData)k+=i+h+j,k+='Content-Disposition: form-data; name="'+key+'"'+j+j,k+=f.formData[key]+j;k+=i+h+i+j,xhr.upload.addEventListener("progress",function(a){e.progress(a,b)},!1),xhr.addEventListener("load",function(a){b.uploading=!1;var d=this.status;404==d?e.error("404_FILE_NOT_FOUND",b,c):"Invalid file type."!=b.xhr.responseText?e.uploadComplete(a,b,c):e.error(b.xhr.responseText,b,c)},!1);var l=f.uploadScript;if("get"==f.method){var m=a(f.formData).param();l+=m}xhr.open(f.method,f.uploadScript,!0),xhr.setRequestHeader("Content-Type","multipart/form-data; boundary="+h),"function"==typeof f.onUploadFile&&f.onUploadFile.call(d,b),xhr.sendAsBinary(k)},h.readAsBinaryString(b)}},e.progress=function(b,c){if(a.inArray("onProgress",f.overrideEvents)<0){if(b.lengthComputable)var e=Math.round(b.loaded/b.total*100);c.queueItem.find(".fileinfo").html(" - "+e+"%"),c.queueItem.find(".progress-bar").css("width",e+"%")}"function"==typeof f.onProgress&&f.onProgress.call(d,c,b)},e.error=function(c,g,h){if(a.inArray("onError",f.overrideEvents)<0){switch(c){case"404_FILE_NOT_FOUND":errorMsg="404 Error";break;case"403_FORBIDDEN":errorMsg="403 Forbidden";break;case"FORBIDDEN_FILE_TYPE":errorMsg="Forbidden File Type";break;case"FILE_SIZE_LIMIT_EXCEEDED":errorMsg="File Too Large";break;default:errorMsg="Unknown Error"}g.queueItem.addClass("error").find(".fileinfo").html(" - "+errorMsg),g.queueItem.find(".progress").remove()}"function"==typeof f.onError&&f.onError.call(d,c,g),g.skip=!0,"404_FILE_NOT_FOUND"==c?e.uploads.errors++:e.queue.errors++,h&&b.upload.call(d,null,!0)},e.uploadComplete=function(c,g,h){a.inArray("onUploadComplete",f.overrideEvents)<0&&(g.queueItem.find(".progress-bar").css("width","100%"),g.queueItem.find(".fileinfo").html(" - Completed"),g.queueItem.find(".progress").slideUp(250),g.queueItem.addClass("complete")),"function"==typeof f.onUploadComplete&&f.onUploadComplete.call(d,g,g.xhr.responseText),f.removeCompleted&&setTimeout(function(){b.cancel.call(d,g)},3e3),g.complete=!0,e.uploads.successful++,e.uploads.count++,e.uploads.current--,delete g.xhr,h&&b.upload.call(d,null,!0)},e.queueComplete=function(){"function"==typeof f.onQueueComplete&&f.onQueueComplete.call(d,e.uploads)},!(window.File&&window.FileList&&window.Blob&&(window.FileReader||window.FormData)))return"function"==typeof f.onFallback&&f.onFallback.call(d),!1;if(f.id="uploadifive-"+d.attr("id"),e.button=a('<div id="'+f.id+'" class="uploadifive-button">'+f.buttonText+"</div>"),f.buttonClass&&e.button.addClass(f.buttonClass),e.button.css({height:f.height,"line-height":f.height+"px",overflow:"hidden",position:"relative","text-align":"center",width:f.width}),d.before(e.button).appendTo(e.button).hide(),e.createInput.call(d),f.queueID?e.queueEl=a("#"+f.queueID):(f.queueID=f.id+"-queue",e.queueEl=a('<div id="'+f.queueID+'" class="uploadifive-queue" />'),e.button.after(e.queueEl)),f.dnd){var h=f.dropTarget?a(f.dropTarget):e.queueEl.get(0);h.addEventListener("dragleave",function(a){a.preventDefault(),a.stopPropagation()},!1),h.addEventListener("dragenter",function(a){a.preventDefault(),a.stopPropagation()},!1),h.addEventListener("dragover",function(a){a.preventDefault(),a.stopPropagation()},!1),h.addEventListener("drop",e.drop,!1)}XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(a){function b(a){return 255&a.charCodeAt(0)}var c=Array.prototype.map.call(a,b),d=new Uint8Array(c);this.send(d.buffer)}),"function"==typeof f.onInit&&f.onInit.call(d)})},debug:function(){return this.each(function(){console.log(a(this).data("uploadifive"))})},clearQueue:function(){this.each(function(){var c=a(this),d=c.data("uploadifive"),e=d.settings;for(var f in d.inputs)for(input=d.inputs[f],limit=input.files.length,i=0;i<limit;i++)file=input.files[i],b.cancel.call(c,file);"function"==typeof e.onClearQueue&&e.onClearQueue.call(c,a("#"+d.settings.queueID))})},cancel:function(c,d){this.each(function(){var e=a(this),f=e.data("uploadifive"),g=f.settings;"string"==typeof c&&(isNaN(c)||(fileID="uploadifive-"+a(this).attr("id")+"-file-"+c),c=a("#"+fileID).data("file")),c.skip=!0,f.filesCancelled++,c.uploading&&(f.uploads.current--,c.uploading=!1,c.xhr.abort(),delete c.xhr,b.upload.call(e)),a.inArray("onCancel",g.overrideEvents)<0&&f.removeQueueItem(c,d),"function"==typeof g.onCancel&&g.onCancel.call(e,c)})},upload:function(b,c){this.each(function(){var d=a(this),e=d.data("uploadifive"),f=e.settings;if(b)e.uploadFile.call(d,b);else if(e.uploads.count+e.uploads.current<f.uploadLimit||0==f.uploadLimit){if(!c){e.uploads.attempted=0,e.uploads.successsful=0,e.uploads.errors=0;var g=e.filesToUpload();"function"==typeof f.onUpload&&f.onUpload.call(d,g)}a("#"+f.queueID).find(".uploadifive-queue-item").not(".error, .complete").each(function(){return _file=a(this).data("file"),e.uploads.current>=f.simUploadLimit&&0!==f.simUploadLimit||e.uploads.current>=f.uploadLimit&&0!==f.uploadLimit||e.uploads.count>=f.uploadLimit&&0!==f.uploadLimit?!1:void(f.checkScript?(_file.checking=!0,skipFile=e.checkExists(_file),_file.checking=!1,skipFile||e.uploadFile(_file,!0)):e.uploadFile(_file,!0))}),0==a("#"+f.queueID).find(".uploadifive-queue-item").not(".error, .complete").size()&&e.queueComplete()}else 0==e.uploads.current&&(a.inArray("onError",f.overrideEvents)<0&&e.filesToUpload()>0&&0!=f.uploadLimit&&alert("The maximum upload limit has been reached."),"function"==typeof f.onError&&f.onError.call(d,"UPLOAD_LIMIT_EXCEEDED",e.filesToUpload()))})},destroy:function(){this.each(function(){var c=a(this),d=c.data("uploadifive"),e=d.settings;b.clearQueue.call(c),e.queueID||a("#"+e.queueID).remove(),c.siblings("input").remove(),c.show().insertBefore(d.button),d.button.remove(),"function"==typeof e.onDestroy&&e.onDestroy.call(c)})}};a.fn.uploadifive=function(c){return b[c]?b[c].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof c&&c?void a.error("The method "+c+" does not exist in $.uploadify"):b.init.apply(this,arguments)}}(jQuery)}});